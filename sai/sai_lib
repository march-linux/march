#!/bin/bash

say() {
	tput setaf 4
	echo ":: $1"
	tput sgr0
}

ask() {
	tput setaf 6
	echo -n "=> $1  "
	tput sgr0
	read ans
}

yell() {
	tput setaf 1
	echo "!! $1  (see the error message above)"
	tput sgr0
	ask "sai found an error. type 'yes' to continue anyway."
	if [ "$ans" != "yes" ]; then
		exit
	fi
}

prepare_disks() {
	for line in $(cat $FS); do
		part=$(echo $line | cut -d : -f 1)
		mp=$(echo $line | cut -d : -f 2)
		fstype=$(echo $line | cut -d : -f 3)

		if [ "$fstype" == "swap" ]; then
			mkswap $part || yell "sai can't format $part as swap"
		else
			mkfs.$fstype $part || yell "sai can't format $part as $fstype"
			mkdir -p /mnt$mp
			mount -t $fstype $part /mnt$mp || yell "sai can't mount $part as $mp"
		fi
		
		echo -n "$part $mp $fstype defaults 0 " >> $FSTAB
		if [ "$fstype" == "swap" ]; then
			echo "0" >> $FSTAB
		else
			echo "1" >> $FSTAB
		fi
	done
}

find_disks() {
	find /sys/block/* -name [hs]d* | cut -d / -f 4
}

find_partitions() {
	find /sys/block/[hs]d*/* -name [hs]d* | cut -d / -f 5
}

disk_capacity() {
	fdisk -l $1 | sed -n '2p' | cut -d ' ' -f 3,4 | sed 's|,$||'
}

avail_disks() {
	for disk in $(find_disks); do
		echo "$disk: $(disk_capacity /dev/$disk)"
	done
}

# chroot_mount()
# prepares target system as a chroot
#
chroot_mount() {
	mkdir -p /mnt/sys /mnt/proc /mnt/dev
	mount -t sysfs sysfs /mnt/sys && mount -t proc proc /mnt/proc && mount -o bind /dev /mnt/dev \
	|| yell "sai can't enable chroot"
}

# chroot_umount()
# tears down chroot in target system
#
chroot_umount() {
	umount /mnt/proc /mnt/sys /mnt/dev || yell "sai can't disable chroot"
}

pacman_install() {
	mkdir -p /mnt/var/lib/pacman /mnt/var/cache/pacman/pkg
	chroot_mount
	pacman --root /mnt --cachedir /mnt/var/cache/pacman/pkg --noconfirm --needed \
		-Sy $(grep -v ^# /sai/packages.list) || yell "pacman has some problems"
	chroot_umount
}

search_device() {
	grep ":$1:" $FS | cut -d : -f 1
}

generate_syslinux_menu() {
	rootpart=$(search_device '/')
	sed -i -e "s|root=/dev/sda3|root=$rootpart|g" $syslinuxmenu || yell "sai can't find the bootloader menu"
}