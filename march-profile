#!/bin/bash

BLOCK_ROLLBACK_USELESS=1

worker_intro ()
{
	notify "March installation may take a while. Have some coffee."
}

worker_configure ()
{
	var_UI_TYPE="dia"
	ui_init
}

worker_select_source ()
{
	var_PKG_SOURCE_TYPE="net"
	var_SYNC_URL="ftp://mirrors.kernel.org/archlinux/\$repo/os/\$arch"
}

worker_prepare_disks ()
{
	get_possible_fs && interactive_prepare_disks
}

worker_package_list ()
{
	var_TARGET_PACKAGES="$(grep -v ^# /march/packages.list)"
}

worker_configure_system ()
{
	notify "Configuring March"
	# copy march config
	cp /etc/sudoers $var_TARGET_DIR/etc/
	cp /etc/pacman.d/mirrorlist $var_TARGET_DIR/etc/pacman.d/
	cp /etc/locale.gen $var_TARGET_DIR/etc/
	cp /etc/modprobe.d/modprobe.conf $var_TARGET_DIR/etc/modprobe.d/
	# setup rc.conf
	sed -i -e "s|^DAEMONS=.*|DAEMONS=(dbus networkmanager gdm avahi-daemon cupsd)|" $var_TARGET_DIR/etc/rc.conf
	# adduser and setup locale
	target_locale-gen
	chroot $var_TARGET_DIR usermod -p ZYCnDaw9NK8NI root
	chroot $var_TARGET_DIR useradd -m -p ZYCnDaw9NK8NI -g users -G audio,lp,network,optical,power,storage,video,wheel march
}

worker_install_bootloader ()
{
	bootloader="grub"
	export EDITOR="vim"
	interactive_install_bootloader
}

worker_msg_report ()
{
	notify $(show_report)
}
